#!/bin/bash

# Проверка СИК'ов через скрипт crric
# 02/07/2003 SASCO
# 
# Вызов скрипта:
#       prsic <имя файла с СИКами> <имя LOG файла>
#
# Формат строки файла с СИКами:
# N строки в SWIFT.TXT | N записи в REGS.DBF | SIK | ФИОДДММГГГГ
#
# Коды возврата программы crric
#                              0 - нет ошибок
#                              1 - Ошибка четности СИК (неверная длина)
#                              2 - Ошибка контроля правильности заполнения СИК (присутсвуют недопустимые символы)
#                              3 - Ошибка соответствия СИК набору индивидуальных данных (не соответсвует ФИО и дате рождения)

if ! test "$1"; then echo "Ошибка проверки СИК: Скрипт (PRSIC) запущен без параметров"; exit 1; fi


if ! test "$2"; then echo "Ошибка проверки СИК: (Скрипт PRSIC) Не указан файл для записи LOG"; exit 2; fi


if ! test -f $1; then echo "Ошибка проверки СИК: (Скрипт PRSIC) Не найден файл $1" >> $2; exit 3; fi

#echo>$2

#
# Основная часть скрипта - разбор файла по строчкам
#

#dos-un $1 $1.un.sik
#dos2win $1 $1.un.sik
#cp $1 $1.un.sik
cat $1 | awk ' 

   BEGIN {  FS="|";
            SICRET="";
            CMDL="";
         } 

   {     
         if (NF != 4) {
             print "Ошибка проверки СИК: Строка " NR " - Не верный формат строки";
         }
         else {  
                 CMDL="SICRET=`crrickz " substr($3,1,16)","$4"` ; exit $SICRET;";
                 SICRET = system (CMDL);

                 if (SICRET == "1") {print "Ошибка СИК ";
                                   print " -> Cм номер строки в файле Swift.txt: " $1;
                                   print " -> или порядковый номер в списке : " $2;
                                  }

                 if (SICRET == "2") {print "Ошибка контроля правильности заполнения СИК (присутствуют недопустимые символы)";
                                   print " -> Cм номер строки в файле Swift.txt: " $1;
                                   print " -> или порядковый номер в списке : " $2;
                                  }

                 if (SICRET == "3") {print "Ошибка соответствия СИК набору индивидуальных данных (не соответствует ФИО и дате рождения)";
                                   print " -> Cм номер строки в файле Swift.txt: " $1;
                                   print " -> или порядковый номер в списке : " $2;
                                  }
         }
   }

' >> $2
